{% extends "base.html" %}

{% block content %}

<h3 class="mb-4">Admin Dashboard</h3>

<div class="row mb-4">
    <div class="col-md-6">

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="alert alert-info mb-0">
                    <strong>Visitors Today:</strong> {{ total }}<br>
                    <strong>Currently Inside:</strong> {{ inside_count }}
                </div>
            </div>
            <!-- export & logout buttons ... -->
        </div>
    </div>
    <div class="col-md-6 text-end">
        <a href="{{ url_for('export') }}" class="btn btn-success">Export CSV</a>
        <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-danger ms-2">Logout</a>
    </div>
</div>

<!-- Filters: Search + Date range -->
<form method="GET" class="mb-4">
    <div class="row g-3">
        <div class="col-md-5">
            <input type="text" name="q" class="form-control" placeholder="Search name or phone..." value="{{ q }}">
        </div>
        <div class="col-md-3">
            <input type="date" name="start" class="form-control" value="{{ start_date or '' }}">
        </div>
        <div class="col-md-3">
            <input type="date" name="end" class="form-control" value="{{ end_date or '' }}">
        </div>
        <div class="col-md-1">
            <button type="submit" class="btn btn-primary w-100">Filter</button>
        </div>
    </div>
</form>

<!-- Visitor Table -->
{% if visitors %}
<table class="table table-bordered table-hover table-striped">
    <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Purpose</th>
            <th>Check-in</th>
            <th>Check-out</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        {% for v in visitors %}
        <tr>
            <td>{{ v[0] }}</td>
            <td>{{ v[1] }}</td>
            <td>{{ v[2] }}</td>
            <td>{{ v[3] }}</td>
            <td>{{ v[4] }}</td>
            <td>
                {% if v[5] %}{{ v[5] }}{% else %}-{% endif %}
            </td>
            <td>
                {% if v[5] %}
                <span class="badge bg-success">Checked Out</span>
                {% else %}
                <span class="badge bg-warning">Inside</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p class="text-muted">No visitors found matching your filters.</p>
{% endif %}

<!-- ... your existing filters, table, etc. stay above ... -->

<!-- Chart section -->
<div class="card mt-5 shadow-sm">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Visitors per Day</h5>
    </div>
    <div class="card-body">
        <canvas id="visitorChart" height="140"></canvas>
    </div>
</div>

<!-- Chart data (hidden) -->
<script id="chart-data" type="application/json">
    {{ chart_data | tojson }}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const canvas = document.getElementById('visitorChart');
        if (!canvas) {
            console.error("Canvas element not found");
            return;
        }

        const chartDataRaw = document.getElementById('chart-data').textContent;
        let chartData;
        try {
            chartData = JSON.parse(chartDataRaw);
        } catch (e) {
            console.error("Invalid chart data:", e);
            return;
        }

        const labels = Object.keys(chartData);
        const values = Object.values(chartData);

        if (labels.length === 0) {
            console.warn("No chart data available");
            return;
        }

        new Chart(canvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Number of Visitors',
                    data: values,
                    backgroundColor: 'rgba(54, 162, 235, 0.65)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 },
                        title: { display: true, text: 'Visitors' }
                    },
                    x: {
                        title: { display: true, text: 'Date' },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                plugins: {
                    legend: { display: true, position: 'top' }
                }
            }
        });
    });
</script>

{% endblock %}